<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SENA PHOTOBOOTH | OS 2.4 (2x2 GRID)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700;800&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           STYLE: SYSTEM CORE
           ========================================= */
        :root {
            --bg-color: #000;
            --text-main: #E0E0E0;
            --font-ui: 'DM Sans', sans-serif;
            --font-code: 'VT323', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color);
            height: 100vh; width: 100vw;
            overflow: hidden;
            color: var(--text-main);
            font-family: var(--font-ui);
            display: flex; justify-content: center; align-items: center;
        }

        #monitor {
            width: 100%; height: 100%;
            position: relative;
            background: #050505;
        }

        /* CRT Effects */
        .scanlines {
            position: absolute; inset: 0; pointer-events: none; z-index: 100;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
        }
        .vignette {
            position: absolute; inset: 0; pointer-events: none; z-index: 101;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
        }

        /* Screens */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease;
            z-index: 10;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* BOOT */
        #screen-boot {
            justify-content: flex-start; padding: 40px;
            font-family: var(--font-code); font-size: 1.2rem; color: #0f0; background: #000; z-index: 200;
        }

        /* HOME */
        #screen-home {
            justify-content: center; align-items: center; text-align: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        .main-title {
            font-size: 3.5rem; font-weight: 800; color: #fff; margin-bottom: 40px;
            text-shadow: 0 0 20px rgba(255,255,255,0.4);
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .btn-coin {
            background: transparent; border: 2px solid #fff;
            padding: 15px 40px; color: #fff;
            font-family: var(--font-code); font-size: 1.8rem;
            cursor: pointer; transition: 0.2s;
        }
        .btn-coin:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .blink { animation: blink 1.5s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        /* FRAMES */
        #screen-frames {
            justify-content: center; align-items: center; background: #080808; padding: 20px;
        }
        .frame-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; max-width: 500px;
        }
        .btn-frame {
            background: #111; border: 1px solid #444; color: #aaa;
            padding: 20px; text-align: center; cursor: pointer;
            font-family: var(--font-code); font-size: 1.1rem;
            border-radius: 4px; transition: 0.2s;
        }
        .btn-frame:active { background: #fff; color: #000; }
        .btn-frame.special { grid-column: span 2; border-color: #fff; color: #fff; }

        /* CAM */
        #screen-cam { justify-content: space-between; background: #000; }
        .viewport { flex: 1; position: relative; overflow: hidden; background: #050505; }
        video#video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            font-size: 10rem; font-weight: 800; color: #fff; display: none; text-shadow: 4px 4px 0 #000;
        }
        .ui-controls {
            height: 120px; background: #111; border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: center; gap: 20px;
        }
        .btn-shutter {
            width: 80px; height: 80px; border: 2px solid #666; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .shutter-inner { width: 68px; height: 68px; background: #fff; border-radius: 50%; transition: 0.1s; }
        .btn-shutter:active .shutter-inner { transform: scale(0.9); background: #ccc; }

        /* RESULT */
        #screen-result { justify-content: center; align-items: center; background: #0a0a0a; }
        .preview-container {
            max-height: 70vh; padding: 5px; border: 1px solid #333;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); margin-bottom: 20px;
            opacity: 0; transform: translateY(20px); transition: 0.5s;
        }
        .preview-container.show { opacity: 1; transform: translateY(0); }
        .preview-container img { height: 55vh; display: block; }
        .action-btns { display: flex; gap: 15px; }
        .btn-action {
            padding: 12px 30px; font-family: var(--font-ui); font-weight: 700;
            background: #fff; color: #000; border: none; cursor: pointer;
        }

        #flash { position: fixed; inset: 0; background: #fff; z-index: 999; opacity: 0; pointer-events: none; }
        .do-flash { animation: flash 0.2s linear; }
        @keyframes flash { 0%,100%{opacity:0;} 50%{opacity:1;} }
    </style>
</head>
<body>

    <div id="monitor">
        <div class="scanlines"></div>
        <div class="vignette"></div>

        <div id="screen-boot" class="screen active">
            <div id="boot-log"></div>
        </div>

        <div id="screen-home" class="screen">
            <div class="main-title">SENA<br>PHOTOBOOTH</div>
            <div class="btn-coin" onclick="OS.start()">
                <span class="blink">TAP TO START</span>
            </div>
        </div>

        <div id="screen-frames" class="screen">
            <h2 style="font-family:var(--font-code); color:#fff; margin-bottom:20px;">SELECT LAYOUT</h2>
            <div class="frame-grid">
                <div class="btn-frame" onclick="OS.selectFrame('strip')">1. STRIP (3 SHOTS)</div>
                <div class="btn-frame" onclick="OS.selectFrame('disco')">2. DISCO (2x2) ✨</div>
                <div class="btn-frame" onclick="OS.selectFrame('love')">3. LOVE (2x2) ❤️</div>
                <div class="btn-frame" onclick="OS.selectFrame('system')">4. SYSTEM (3 SHOTS)</div>
            </div>
        </div>

        <div id="screen-cam" class="screen">
            <div class="viewport">
                <video id="video-feed" autoplay playsinline muted></video>
                <div id="countdown">3</div>
            </div>
            <div class="ui-controls">
                <div class="btn-shutter" onclick="OS.snap()">
                    <div class="shutter-inner"></div>
                </div>
            </div>
        </div>

        <div id="screen-result" class="screen">
            <div class="preview-container" id="preview-box">
                <img id="final-img">
            </div>
            <div class="action-btns">
                <button class="btn-action" onclick="OS.download()">SAVE</button>
                <button class="btn-action" style="background:#333; color:#fff;" onclick="location.reload()">AGAIN</button>
            </div>
        </div>
    </div>

    <div id="flash"></div>
    <canvas id="hidden-canvas" style="display:none"></canvas>

    <script>
        const OS = (function() {
            // CONFIG
            const C = { w: 1280, h: 720 };
            
            // STATE
            let s = { frame: 'strip', photos: [], stream: null, processing: false, shots: 3 };

            // DOM
            const D = {
                screens: {
                    boot: document.getElementById('screen-boot'),
                    home: document.getElementById('screen-home'),
                    frames: document.getElementById('screen-frames'),
                    cam: document.getElementById('screen-cam'),
                    res: document.getElementById('screen-result')
                },
                video: document.getElementById('video-feed'),
                canvas: document.getElementById('hidden-canvas'),
                count: document.getElementById('countdown'),
                flash: document.getElementById('flash'),
                final: document.getElementById('final-img'),
                box: document.getElementById('preview-box'),
                log: document.getElementById('boot-log')
            };

            const Aud = {
                play: () => {
                    const ctx = new (window.AudioContext||window.webkitAudioContext)();
                    const o = ctx.createOscillator(); const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type='square'; o.frequency.value=800; g.gain.value=0.1;
                    o.start(); o.stop(ctx.currentTime+0.1);
                }
            };

            // INIT
            window.onload = async () => {
                const logs = ["SYSTEM BOOT...", "LOADING GRAPHICS...", "READY."];
                for(let l of logs) { D.log.innerHTML += l + "<br>"; await new Promise(r=>setTimeout(r,300)); }
                D.screens.boot.classList.remove('active');
                D.screens.home.classList.add('active');
            };

            async function start() {
                D.screens.home.classList.remove('active');
                D.screens.frames.classList.add('active');
            }

            async function selectFrame(type) {
                s.frame = type;
                // กำหนดจำนวนช็อต: ถ้าเป็น Disco หรือ Love (2x2) ให้ถ่าย 4 รูป
                s.shots = (type === 'disco' || type === 'love') ? 4 : 3;
                
                try {
                    s.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: C.w, height: C.h } });
                    D.video.srcObject = s.stream;
                    D.screens.frames.classList.remove('active');
                    D.screens.cam.classList.add('active');
                } catch(e) { alert("Camera Error"); }
            }

            async function snap() {
                if(s.processing) return;
                s.processing = true; s.photos = [];
                
                for(let i=0; i<s.shots; i++) {
                    await countdown(3);
                    await capture();
                    await new Promise(r => setTimeout(r, 500));
                }
                process();
            }

            function countdown(n) {
                return new Promise(r => {
                    let c = n; D.count.style.display = 'block'; D.count.innerText = c;
                    const t = setInterval(() => {
                        Aud.play(); c--;
                        if(c>0) D.count.innerText = c;
                        else { clearInterval(t); D.count.style.display = 'none'; r(); }
                    }, 1000);
                });
            }

            function capture() {
                return new Promise(r => {
                    D.flash.classList.add('do-flash');
                    setTimeout(() => D.flash.classList.remove('do-flash'), 200);
                    
                    const cvs = document.createElement('canvas');
                    cvs.width = D.video.videoWidth; cvs.height = D.video.videoHeight;
                    const ctx = cvs.getContext('2d');
                    ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
                    ctx.drawImage(D.video, 0, 0);
                    
                    s.photos.push(cvs);
                    r();
                });
            }

            // --- FUNCTION สร้างกราฟิก Disco แบบ Code ล้วน ---
            function drawDiscoBg(ctx, w, h) {
                // Background ดำ
                ctx.fillStyle = '#111'; ctx.fillRect(0,0,w,h);
                // สร้างตารางกระจก
                const size = 30;
                for(let y=0; y<h; y+=size) {
                    for(let x=0; x<w; x+=size) {
                        const gray = Math.random() * 200 + 55; // สุ่มความสว่าง
                        ctx.fillStyle = `rgb(${gray},${gray},${gray})`;
                        ctx.fillRect(x,y,size-1,size-1);
                        // เงาวาว
                        ctx.fillStyle = 'rgba(255,255,255,0.2)';
                        ctx.fillRect(x,y,size-1,size/2);
                    }
                }
                // ใส่ประกายวิบวับ
                for(let i=0; i<40; i++) {
                    const lx = Math.random()*w; const ly = Math.random()*h;
                    ctx.fillStyle = '#fff';
                    ctx.beginPath(); ctx.arc(lx, ly, Math.random()*4+2, 0, Math.PI*2); ctx.fill();
                }
            }

            function process() {
                if(s.stream) s.stream.getTracks().forEach(t=>t.stop());

                // กำหนดขนาด Canvas
                // Strip: 600x(สูง)
                // 2x2: 800x1000 (โดยประมาณ 4:5 ratio)
                let W = 600, H = 1600; 
                if(s.frame === 'disco' || s.frame === 'love') {
                    W = 800; H = 1000;
                }

                D.canvas.width = W; D.canvas.height = H;
                const ctx = D.canvas.getContext('2d');

                // 1. วาดพื้นหลัง
                if(s.frame === 'disco') {
                    drawDiscoBg(ctx, W, H);
                } else if(s.frame === 'love') {
                    ctx.fillStyle = '#ffc0cb'; // ชมพู
                    ctx.fillRect(0,0,W,H);
                    // ลายจุดขาว
                    ctx.fillStyle = '#fff';
                    for(let i=0; i<200; i++) {
                        ctx.beginPath(); 
                        ctx.arc(Math.random()*W, Math.random()*H, 5, 0, Math.PI*2); 
                        ctx.fill();
                    }
                } else {
                    ctx.fillStyle = (s.frame==='system') ? '#000' : '#fff';
                    ctx.fillRect(0,0,W,H);
                }

                // 2. วาดข้อความหัวกระดาษ (SENA PHOTOBOOTH)
                ctx.textAlign = 'center';
                const titleText = "SENA PHOTOBOOTH";
                
                if(s.frame === 'disco') {
                    ctx.fillStyle = '#fff'; 
                    ctx.font = '900 60px "DM Sans"';
                    ctx.shadowColor="black"; ctx.shadowBlur=10;
                    ctx.fillText(titleText, W/2, 100);
                    ctx.shadowBlur=0;
                } else if (s.frame === 'love') {
                    ctx.fillStyle = '#d32f2f'; // แดงเข้ม
                    ctx.font = 'bold 60px "DM Sans"';
                    ctx.fillText(titleText, W/2, 100);
                } else {
                    ctx.fillStyle = (s.frame==='system')?'#0f0':'#000';
                    ctx.font = 'bold 50px "DM Sans"';
                    ctx.fillText(titleText, W/2, 80);
                }

                // 3. วาดรูปภาพ
                if (s.frame === 'disco' || s.frame === 'love') {
                    // --- LOGIC 2x2 GRID (4 รูป) ---
                    // ขนาดรูปย่อย
                    const margin = 40;
                    const pW = (W - (margin*3)) / 2; // (800 - 120) / 2 = 340
                    const pH = pW * 0.75; // 4:3 landscape ratio
                    
                    const startY = 150;
                    
                    // ตำแหน่ง x,y ของ 4 ช่อง
                    const pos = [
                        {x: margin, y: startY},                  // TL
                        {x: margin*2 + pW, y: startY},           // TR
                        {x: margin, y: startY + pH + margin},    // BL
                        {x: margin*2 + pW, y: startY + pH + margin} // BR
                    ];

                    s.photos.forEach((p, i) => {
                        if(i < 4) {
                            // Border
                            ctx.fillStyle = (s.frame==='disco') ? '#fff' : '#fff';
                            ctx.fillRect(pos[i].x - 5, pos[i].y - 5, pW + 10, pH + 10);
                            
                            // Image (Crop center)
                            const sR = p.width/p.height; const dR = pW/pH;
                            let sx, sy, sw, sh;
                            if(sR > dR) { sh=p.height; sw=sh*dR; sx=(p.width-sw)/2; sy=0; }
                            else { sw=p.width; sh=sw/dR; sx=0; sy=(p.height-sh)/2; }
                            
                            ctx.drawImage(p, sx, sy, sw, sh, pos[i].x, pos[i].y, pW, pH);
                        }
                    });

                } else {
                    // --- LOGIC VERTICAL STRIP (3 รูป) ---
                    const pW = 500; const pH = pW * 0.75;
                    let y = 120;
                    s.photos.forEach(p => {
                        // Image cropping logic same as above
                        const sR = p.width/p.height; const dR = pW/pH;
                        let sx, sy, sw, sh;
                        if(sR > dR) { sh=p.height; sw=sh*dR; sx=(p.width-sw)/2; sy=0; }
                        else { sw=p.width; sh=sw/dR; sx=0; sy=(p.height-sh)/2; }

                        ctx.drawImage(p, sx, sy, sw, sh, (W-pW)/2, y, pW, pH);
                        y += pH + 30;
                    });
                }

                // 4. FOOTER DATE
                ctx.font = '24px "VT323"';
                ctx.fillStyle = (s.frame==='disco' || s.frame==='system') ? '#fff' : '#000';
                if(s.frame==='disco') ctx.shadowBlur=5;
                ctx.fillText(new Date().toLocaleDateString(), W/2, H - 30);

                // SHOW RESULT
                D.final.src = D.canvas.toDataURL('image/jpeg', 0.95);
                D.screens.cam.classList.remove('active');
                D.screens.res.classList.add('active');
                setTimeout(() => D.box.classList.add('show'), 100);
            }

            function download() {
                const a = document.createElement('a');
                a.download = `SENA_${Date.now()}.jpg`;
                a.href = D.canvas.toDataURL('image/jpeg');
                a.click();
            }

            return { start, selectFrame, snap, download };
        })();
    </script>
</body>
</html>
