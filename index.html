<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENA PHOTOBOOTH | HYBRID</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@500;700;800&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. SETUP & VARS
           ========================================= */
        :root {
            /* Cabinet Colors */
            --cab-body: #E6E6E3;
            --cab-shade: #CDCDC9;
            --cab-border: #1F1F1F;
            
            /* Screen Colors */
            --screen-bg: #050505;
            --phosphor: #f0f0f0;
            --accent: #FF3333;
            
            /* Dims */
            --cab-w: 900px;
            --cab-h: 750px;
            
            --f-ui: 'DM Sans', sans-serif;
            --f-digi: 'VT323', monospace;
        }

        body {
            margin: 0; padding: 0;
            background-color: #f2f2f2;
            background-image: radial-gradient(#d1d1d1 15%, transparent 16%), radial-gradient(#d1d1d1 15%, transparent 16%);
            background-size: 30px 30px; background-position: 0 0, 15px 15px;
            height: 100vh;
            display: flex; justify-content: center; align-items: center;
            font-family: var(--f-ui);
            overflow: hidden;
            user-select: none;
        }

        /* =========================================
           2. THE PHYSICAL CABINET
           ========================================= */
        #cabinet {
            width: 95%; max-width: var(--cab-w);
            height: 95vh; max-height: var(--cab-h);
            background: linear-gradient(135deg, var(--cab-body) 0%, var(--cab-shade) 100%);
            border: 4px solid var(--cab-border);
            border-radius: 40px;
            position: relative;
            box-shadow: 
                25px 25px 0px rgba(0,0,0,0.15),
                inset 5px 5px 20px rgba(255,255,255,0.5),
                inset -5px -5px 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            padding: 35px;
            z-index: 10;
        }

        /* Screws */
        .screw {
            position: absolute; width: 14px; height: 14px;
            background: #bbb; border-radius: 50%;
            border: 1px solid #777;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            z-index: 20;
        }
        .screw::after { content:''; position:absolute; top:50%; left:15%; right:15%; height:2px; background:#666; transform:translateY(-50%) rotate(45deg); }
        .screw.tl { top:15px; left:15px; } .screw.tr { top:15px; right:15px; }
        .screw.bl { bottom:15px; left:15px; } .screw.br { bottom:15px; right:15px; }

        /* =========================================
           3. THE MONITOR (CRT)
           ========================================= */
        .monitor-frame {
            flex: 1;
            background: #222;
            border-radius: 20px;
            padding: 20px;
            box-shadow: inset 0 0 20px #000;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        .crt-glass {
            width: 100%; height: 100%;
            background: var(--screen-bg);
            border-radius: 4px; /* Slight curve */
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.05);
        }

        /* CRT Effects */
        .scanlines {
            position: absolute; inset: 0; pointer-events: none; z-index: 90;
            background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.2) 50%);
            background-size: 100% 4px;
        }
        .crt-glow {
            position: absolute; inset: 0; pointer-events: none; z-index: 91;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.4) 100%);
            box-shadow: inset 0 0 40px rgba(0,0,0,0.5);
        }

        /* =========================================
           4. OS SCREENS (INSIDE CRT)
           ========================================= */
        .os-screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            transition: opacity 0.5s;
            opacity: 0; pointer-events: none;
        }
        .os-screen.active { opacity: 1; pointer-events: auto; }
        
        /* Boot Screen */
        #os-boot {
            padding: 30px; font-family: var(--f-digi); color: #0f0; font-size: 1.2rem;
            justify-content: flex-start;
        }
        
        /* Attract Screen (Logo) */
        #os-attract {
            align-items: center; justify-content: center; text-align: center;
        }
        .logo-big {
            font-size: 3.5rem; font-weight: 800; color: #fff; line-height: 0.9;
            text-shadow: 0 0 15px rgba(255,255,255,0.4); margin-bottom: 20px;
        }
        .insert-msg {
            font-family: var(--f-digi); font-size: 1.8rem; color: #aaa;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Live Camera Screen */
        #os-live { background: #000; }
        video#cam-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .os-overlay { position: absolute; inset: 0; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .rec-tag { color: red; font-family: var(--f-digi); font-size: 1.5rem; text-shadow: 0 0 5px red; }
        #countdown {
            position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            font-size: 10rem; color: #fff; font-weight: 800; display: none; text-shadow: 4px 4px 0 #000;
        }

        /* Processing/Result Screen */
        #os-process {
            align-items: center; justify-content: center; background: #111;
        }
        .loader-text { font-family: var(--f-digi); font-size: 1.5rem; color: #fff; letter-spacing: 2px; }

        /* =========================================
           5. PHYSICAL CONTROL PANEL
           ========================================= */
        .control-panel {
            height: 140px;
            background: #d8d8d6;
            margin-top: 25px;
            border-radius: 15px;
            border: 3px solid #999;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px;
            box-shadow: inset 0 2px 10px rgba(255,255,255,0.8), 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Toggle Switches (Filters) */
        .toggle-group { display: flex; gap: 15px; }
        .phy-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background: #ddd; border: 4px solid #aaa;
            box-shadow: 0 5px 0 #888, 0 10px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.75rem; color: #555;
            cursor: pointer; transition: 0.1s;
        }
        .phy-btn:active { transform: translateY(5px); box-shadow: 0 0 0 #888; }
        .phy-btn.active-filter { background: #fff; border-color: #333; color: #000; box-shadow: 0 5px 0 #000; }
        .phy-btn.active-filter:active { box-shadow: 0 0 0 #000; }

        /* Big Red Button */
        .shutter-group { flex: 1; display: flex; justify-content: center; }
        .big-red {
            width: 90px; height: 90px; background: #e02424;
            border: 5px solid #a81010; border-radius: 50%;
            box-shadow: 0 8px 0 #750808, 0 15px 20px rgba(0,0,0,0.3);
            cursor: pointer; position: relative; transition: 0.1s;
        }
        .big-red::after { content:''; position: absolute; inset: 10px; border-radius: 50%; background: linear-gradient(180deg, rgba(255,255,255,0.4), rgba(255,255,255,0)); }
        .big-red:active { transform: translateY(8px); box-shadow: 0 0 0 #750808; }
        .big-red.disabled { filter: grayscale(100%); pointer-events: none; }

        /* Coin Slot */
        .coin-group { display: flex; flex-direction: column; align-items: center; }
        .coin-slot {
            width: 40px; height: 60px; background: #222; border: 3px solid #666;
            border-radius: 6px; cursor: pointer; position: relative;
            box-shadow: 0 2px 0 #fff;
        }
        .coin-slot::before { content:''; position:absolute; top:12px; left:16px; width:4px; height:36px; background:#000; }
        .coin-label { margin-top: 8px; font-family: var(--f-digi); color: #555; font-size: 1.2rem; }

        /* =========================================
           6. PRINTER MECHANISM
           ========================================= */
        .printer-mech {
            position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            width: 340px; z-index: 5;
        }
        .slot-hole { width: 100%; height: 20px; background: #111; border-radius: 10px; border-bottom: 2px solid #444; }
        
        .photo-paper {
            position: absolute; top: 5px; left: 20px; width: 300px;
            background: #fff; padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transform: translateY(-100%); opacity: 0;
            transition: transform 4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s;
            z-index: -1;
            text-align: center;
        }
        .photo-paper.printed { transform: translateY(20px); opacity: 1; }
        .photo-paper img { width: 100%; display: block; margin-bottom: 10px; border: 1px solid #ddd; }
        .download-btn {
            background: #000; color: #fff; border: none; padding: 8px 16px;
            font-family: var(--f-ui); border-radius: 20px; cursor: pointer;
            margin-top: 5px; font-size: 0.8rem;
        }

        /* Flash FX */
        #flash { position: fixed; inset:0; background:#fff; z-index:9999; opacity:0; pointer-events:none; }
        .fire { animation: flashAnim 0.2s; }
        @keyframes flashAnim { 0%,100%{opacity:0;} 50%{opacity:1;} }

        /* Mobile Adjust */
        @media (max-width: 800px) {
            :root { --cab-w: 98%; --cab-h: 90vh; }
            .control-panel { padding: 10px; height: auto; flex-wrap: wrap; justify-content: center; gap: 20px; }
            .toggle-group { width: 100%; justify-content: center; order: 2; }
            .shutter-group { order: 1; }
            .coin-group { width: 100%; order: 3; margin-top: 10px; }
            .logo-big { font-size: 2.5rem; }
        }

    </style>
</head>
<body>

    <div id="cabinet">
        <div class="screw tl"></div><div class="screw tr"></div>
        <div class="screw bl"></div><div class="screw br"></div>

        <div class="monitor-frame">
            <div class="crt-glass">
                <div class="scanlines"></div>
                <div class="crt-glow"></div>

                <div id="os-boot" class="os-screen active">
                    <div id="boot-txt"></div>
                    <span style="animation:blink 0.5s infinite">_</span>
                </div>

                <div id="os-attract" class="os-screen">
                    <div class="logo-big">SENA<br>PHOTOBOOTH</div>
                    <div class="insert-msg">&lt; INSERT COIN &gt;</div>
                </div>

                <div id="os-live" class="os-screen">
                    <video id="cam-feed" autoplay playsinline muted></video>
                    <div class="os-overlay">
                        <div class="rec-tag">● REC</div>
                        <div id="countdown">3</div>
                    </div>
                </div>

                <div id="os-process" class="os-screen">
                    <div class="loader-text">DEVELOPING FILM...</div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <div class="toggle-group">
                <div class="phy-btn active-filter" onclick="Cabinet.setFilter('color', this)">CLR</div>
                <div class="phy-btn" onclick="Cabinet.setFilter('bw', this)">B&W</div>
                <div class="phy-btn" onclick="Cabinet.setFilter('film', this)">FILM</div>
            </div>

            <div class="shutter-group">
                <div id="btn-shutter" class="big-red disabled" onclick="Cabinet.snap()"></div>
            </div>

            <div class="coin-group">
                <div class="coin-slot" onclick="Cabinet.insertCoin()"></div>
                <div class="coin-label">10 ฿</div>
            </div>
        </div>

        <div class="printer-mech">
            <div class="slot-hole"></div>
            <div id="print-paper" class="photo-paper">
                <img id="final-img" alt="Photo">
                <button class="download-btn" onclick="Cabinet.download()">Save Photo</button>
                <button class="download-btn" style="background:transparent; color:#000; border:1px solid #000; margin-left:5px" onclick="location.reload()">New</button>
            </div>
        </div>
    </div>

    <div id="flash"></div>
    <canvas id="proc-canvas" style="display:none"></canvas>

    <script>
        const Cabinet = (function() {
            
            // CONFIG
            const C = {
                w: 1280, h: 720,
                stripW: 600,
                shots: 3,
                quotes: ["SENA PHOTOBOOTH", "GOOD VIBES", "TIMELESS MEMORY", "CAPTURED MOMENT"]
            };

            // STATE
            let state = {
                mode: 'boot', // boot, attract, live, process, done
                filter: 'color',
                photos: [],
                stream: null
            };

            // DOM
            const D = {
                screens: {
                    boot: document.getElementById('os-boot'),
                    attract: document.getElementById('os-attract'),
                    live: document.getElementById('os-live'),
                    process: document.getElementById('os-process')
                },
                bootTxt: document.getElementById('boot-txt'),
                video: document.getElementById('cam-feed'),
                count: document.getElementById('countdown'),
                shutter: document.getElementById('btn-shutter'),
                flash: document.getElementById('flash'),
                canvas: document.getElementById('proc-canvas'),
                paper: document.getElementById('print-paper'),
                finalImg: document.getElementById('final-img')
            };

            // SOUND FX
            const SFX = {
                ctx: null,
                init: function() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
                beep: function(f=800, t='square') {
                    this.init();
                    const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                    o.type=t; o.frequency.value=f; o.connect(g); g.connect(this.ctx.destination);
                    g.gain.value=0.05; o.start(); o.stop(this.ctx.currentTime+0.1);
                },
                coin: function() {
                    this.init(); this.beep(1200,'sine'); setTimeout(()=>this.beep(2000,'square'),100);
                },
                shutter: function() {
                    this.init();
                    const b=this.ctx.createBuffer(1,this.ctx.sampleRate*0.1,this.ctx.sampleRate);
                    const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                    const s=this.ctx.createBufferSource(); const g=this.ctx.createGain();
                    s.buffer=b; s.connect(g); g.connect(this.ctx.destination);
                    g.gain.value=0.4; s.start();
                }
            };

            // BOOT SEQUENCE
            window.onload = async function() {
                const lines = [
                    "SENA-BIOS v2.0", 
                    "CHECKING HARDWARE... OK", 
                    "CAMERA... DETECTED", 
                    "LOADING OS...", 
                    "SYSTEM READY."
                ];
                for(let l of lines) {
                    D.bootTxt.innerHTML += l + "<br>";
                    await new Promise(r=>setTimeout(r, 400));
                }
                await new Promise(r=>setTimeout(r, 800));
                switchScreen('attract');
                state.mode = 'attract';
            };

            function switchScreen(name) {
                Object.values(D.screens).forEach(s => s.classList.remove('active'));
                D.screens[name].classList.add('active');
            }

            // ACTIONS
            async function insertCoin() {
                if(state.mode !== 'attract') return;
                SFX.coin();
                try {
                    state.stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user', width:C.w, height:C.h}});
                    D.video.srcObject = state.stream;
                    switchScreen('live');
                    state.mode = 'live';
                    D.shutter.classList.remove('disabled');
                } catch(e) { alert("Camera Error"); }
            }

            function setFilter(f, btn) {
                state.filter = f;
                document.querySelectorAll('.phy-btn').forEach(b => b.classList.remove('active-filter'));
                btn.classList.add('active-filter');
                
                let css = 'none';
                if(f==='bw') css = 'grayscale(100%) contrast(1.2)';
                if(f==='film') css = 'sepia(0.3) contrast(1.1) saturate(0.8)';
                D.video.style.filter = css;
                SFX.beep(600);
            }

            async function snap() {
                if(state.mode !== 'live') return;
                state.mode = 'shooting';
                D.shutter.classList.add('disabled');
                state.photos = [];

                for(let i=0; i<C.shots; i++) {
                    await countdown();
                    await capture();
                    await new Promise(r=>setTimeout(r,500));
                }

                process();
            }

            function countdown() {
                return new Promise(r => {
                    let c = 3;
                    D.count.style.display = 'block';
                    D.count.innerText = c;
                    const t = setInterval(() => {
                        SFX.beep();
                        c--;
                        if(c>0) D.count.innerText = c;
                        else {
                            clearInterval(t);
                            D.count.style.display = 'none';
                            r();
                        }
                    }, 1000);
                });
            }

            function capture() {
                return new Promise(r => {
                    SFX.shutter();
                    D.flash.classList.add('fire');
                    setTimeout(()=>D.flash.classList.remove('fire'), 200);

                    const cvs = document.createElement('canvas');
                    cvs.width = D.video.videoWidth; cvs.height = D.video.videoHeight;
                    const ctx = cvs.getContext('2d');
                    
                    ctx.translate(cvs.width,0); ctx.scale(-1,1);
                    ctx.drawImage(D.video,0,0);

                    // Filters
                    if(state.filter !== 'color') {
                        const id = ctx.getImageData(0,0,cvs.width,cvs.height);
                        const d = id.data;
                        for(let i=0; i<d.length; i+=4) {
                            const r=d[i],g=d[i+1],b=d[i+2];
                            if(state.filter==='bw') {
                                const v = 0.299*r+0.587*g+0.114*b;
                                d[i]=d[i+1]=d[i+2]=v;
                            } else if(state.filter==='film') {
                                d[i] = r*0.393+g*0.769+b*0.189;
                                d[i+1] = r*0.349+g*0.686+b*0.168;
                                d[i+2] = r*0.272+g*0.534+b*0.131;
                                const n = (Math.random()-0.5)*20;
                                d[i]+=n; d[i+1]+=n; d[i+2]+=n;
                            }
                        }
                        ctx.putImageData(id,0,0);
                    }
                    
                    state.photos.push(cvs);
                    setTimeout(r, 500);
                });
            }

            function process() {
                if(state.stream) state.stream.getTracks().forEach(t=>t.stop());
                switchScreen('process');
                
                setTimeout(() => {
                    const stripW = C.stripW;
                    const photoW = 520; const photoH = (photoW*3)/4;
                    const gap = 20; const head = 140; const foot = 100;
                    const h = head + (photoH*C.shots) + (gap*(C.shots-1)) + foot;

                    D.canvas.width = stripW; D.canvas.height = h;
                    const ctx = D.canvas.getContext('2d');

                    // Base
                    ctx.fillStyle = '#fdfdfd'; ctx.fillRect(0,0,stripW,h);

                    // Head
                    ctx.fillStyle = '#111'; ctx.textAlign = 'center';
                    ctx.font = 'bold 50px "DM Sans"';
                    ctx.fillText('SENA', stripW/2, 70);
                    ctx.font = '700 30px "DM Sans"';
                    ctx.fillText('PHOTOBOOTH', stripW/2, 110);

                    // Photos
                    let y = head;
                    state.photos.forEach(p => {
                        // Crop
                        const sr = p.width/p.height; const dr=4/3;
                        let sx,sy,sw,sh;
                        if(sr>dr) { sh=p.height; sw=sh*dr; sx=(p.width-sw)/2; sy=0; }
                        else { sw=p.width; sh=sw/dr; sx=0; sy=(p.height-sh)/2; }
                        
                        ctx.drawImage(p,sx,sy,sw,sh, (stripW-photoW)/2, y, photoW, photoH);
                        y += photoH+gap;
                    });

                    // Footer
                    const q = C.quotes[Math.floor(Math.random()*C.quotes.length)];
                    ctx.fillStyle = '#555'; ctx.font = '20px "VT323"';
                    ctx.textAlign = 'center';
                    ctx.fillText(new Date().toLocaleDateString('en-GB') + " | " + q, stripW/2, h-40);

                    // Print Anim
                    D.finalImg.src = D.canvas.toDataURL('image/jpeg', 0.95);
                    D.paper.classList.add('printed');
                    switchScreen('boot'); // Reset screen to black/boot
                    
                }, 2000);
            }

            function download() {
                const l = document.createElement('a');
                l.download = 'SENA-BOOTH.jpg';
                l.href = D.canvas.toDataURL('image/jpeg', 1.0);
                l.click();
            }

            return { insertCoin, setFilter, snap, download };

        })();
    </script>
</body>
</html>
