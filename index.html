<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SENA PHOTOBOOTH | OS 2.0</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;700;800&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. CORE SYSTEM & RESET
           ========================================= */
        :root {
            --bg-deep: #050505;
            --screen-tint: #0a0a0a;
            --phosphor: #E0E0E0;     /* Default Text */
            --phosphor-dim: #666666;
            --accent-main: #FFFFFF;  
            --accent-alert: #FF3333; /* Red for errors/record */
            --accent-ok: #00FF41;    /* Matrix Green */
            
            --scanline-color: rgba(0, 0, 0, 0.4);
            --f-ui: 'DM Sans', sans-serif;
            --f-code: 'VT323', monospace;
            
            --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            background: #000;
            height: 100vh; width: 100vw;
            overflow: hidden;
            color: var(--phosphor);
            font-family: var(--f-ui);
            display: flex; justify-content: center; align-items: center;
        }

        /* =========================================
           2. CRT MONITOR FX
           ========================================= */
        #monitor {
            width: 100%; height: 100%;
            background: var(--screen-tint);
            position: relative;
            overflow: hidden;
        }

        /* Scanlines */
        .scanlines {
            position: absolute; inset: 0; z-index: 900; pointer-events: none;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
        }

        /* Screen Glow / Vignette */
        .screen-glow {
            position: absolute; inset: 0; z-index: 901; pointer-events: none;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
            background: radial-gradient(circle, rgba(20,20,20,0) 60%, rgba(0,0,0,0.4) 100%);
        }

        /* =========================================
           3. LAYOUT MANAGERS
           ========================================= */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.6s var(--ease-out);
            z-index: 10;
            padding: 20px;
        }
        .screen.active { opacity: 1; pointer-events: auto; }
        .screen.hidden { display: none; }

        /* =========================================
           4. BOOT SEQUENCE SCREEN
           ========================================= */
        #screen-boot {
            justify-content: flex-start; align-items: flex-start;
            background: #000; color: var(--accent-ok);
            font-family: var(--f-code); font-size: 1.2rem;
            padding: 40px; line-height: 1.4;
            z-index: 100; /* Top most */
        }
        .cursor-blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* =========================================
           5. ATTRACT MODE (INSERT COIN)
           ========================================= */
        #screen-attract {
            justify-content: center; align-items: center;
            text-align: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }

        .brand-box {
            margin-bottom: 60px;
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

        .title-main {
            font-family: var(--f-ui);
            font-weight: 800;
            font-size: 4rem; /* Big Title */
            line-height: 0.9;
            letter-spacing: -2px;
            color: #fff;
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        .title-sub {
            font-family: var(--f-code);
            font-size: 1.5rem;
            letter-spacing: 5px;
            color: #888;
            margin-top: 10px;
        }

        /* The Coin Button */
        .coin-trigger {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.2);
            padding: 30px 60px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }
        .coin-trigger:hover { border-color: #fff; background: rgba(255,255,255,0.05); }
        .coin-trigger:active { transform: scale(0.96); }
        
        .coin-text {
            font-family: var(--f-code);
            font-size: 2rem;
            color: #fff;
            animation: pulseText 1.5s infinite;
        }
        @keyframes pulseText { 0%{opacity:1;} 50%{opacity:0.4;} 100%{opacity:1;} }

        /* =========================================
           6. LIVE UI (CAMERA)
           ========================================= */
        #screen-live {
            background: #000;
            justify-content: space-between;
            padding: 0; 
        }

        /* Top Bar */
        .top-status {
            height: 60px; width: 100%;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #333;
            background: #111;
            font-family: var(--f-code); font-size: 1.2rem;
        }
        .live-tag { color: var(--accent-alert); font-weight: bold; display: flex; align-items: center; gap:8px;}
        .live-dot { width: 10px; height: 10px; background: var(--accent-alert); border-radius: 50%; }

        /* Viewport */
        .viewfinder {
            flex: 1; position: relative; width: 100%;
            background: #050505;
            overflow: hidden;
        }
        video#cam-feed {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1); /* Mirror */
        }
        
        /* Grid Overlay */
        .grid-lines {
            position: absolute; inset: 0; pointer-events: none;
            display: none; /* Toggled via JS */
        }
        .grid-lines::before {
            content: ''; position: absolute; top:0; bottom:0; left:33.33%; width:33.33%;
            border-left: 1px solid rgba(255,255,255,0.3);
            border-right: 1px solid rgba(255,255,255,0.3);
        }
        .grid-lines::after {
            content: ''; position: absolute; left:0; right:0; top:33.33%; height:33.33%;
            border-top: 1px solid rgba(255,255,255,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }
        .grid-lines.visible { display: block; }

        /* Countdown */
        #count-display {
            position: absolute; top:50%; left:50%; transform: translate(-50%,-50%);
            font-family: var(--f-ui); font-weight: 800; font-size: 12rem;
            color: #fff; text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            display: none;
        }

        /* Controls Area */
        .controls-deck {
            height: 140px; background: #111;
            border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            gap: 20px; padding: 0 20px;
        }

        /* Filter Buttons */
        .btn-opt {
            width: 70px; height: 70px;
            background: transparent; border: 1px solid #444; color: #888;
            border-radius: 8px; cursor: pointer;
            font-family: var(--f-code); font-size: 1rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn-opt.active { background: #fff; color: #000; border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .btn-opt:active { transform: scale(0.95); }

        /* Shutter */
        .shutter-outer {
            width: 90px; height: 90px;
            border: 2px solid #666; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative;
        }
        .shutter-inner {
            width: 76px; height: 76px; background: #fff; border-radius: 50%;
            transition: 0.1s;
        }
        .shutter-outer:active .shutter-inner { transform: scale(0.9); background: #ccc; }
        .shutter-outer.locked { opacity: 0.5; pointer-events: none; }

        /* Grid Toggle (Small) */
        .grid-toggle {
            position: absolute; bottom: 150px; right: 20px;
            background: rgba(0,0,0,0.5); border: 1px solid #fff; color: #fff;
            padding: 8px 12px; border-radius: 20px; font-size: 0.8rem;
            cursor: pointer; z-index: 50;
        }

        /* =========================================
           7. RESULT SCREEN (PRINT)
           ========================================= */
        #screen-result {
            background: #0f0f0f;
            justify-content: center; align-items: center;
        }

        .print-preview-box {
            background: #222; padding: 20px;
            border: 1px solid #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            max-height: 70vh;
            opacity: 0; transform: translateY(20px);
            transition: 0.8s ease;
        }
        .print-preview-box.show { opacity: 1; transform: translateY(0); }
        
        .print-preview-box img {
            height: 55vh; width: auto; display: block;
            border: 1px solid #fff;
        }

        .action-row {
            display: flex; gap: 15px;
        }
        .btn-action {
            background: var(--phosphor); color: #000;
            border: none; padding: 15px 40px;
            font-family: var(--f-ui); font-weight: 700; font-size: 1rem;
            letter-spacing: 1px;
            cursor: pointer; border-radius: 4px;
        }
        .btn-action.secondary { background: transparent; border: 1px solid #fff; color: #fff; }

        /* =========================================
           8. UTILS
           ========================================= */
        #flash-overlay {
            position: fixed; inset:0; background:#fff; z-index:9999;
            opacity:0; pointer-events:none;
        }
        .anim-flash { animation: flash 0.25s ease-out; }
        @keyframes flash { 0% { opacity:1; } 100% { opacity:0; } }

        /* Responsive Fixes */
        @media (max-width: 600px) {
            .title-main { font-size: 2.5rem; }
            .coin-trigger { padding: 20px 40px; }
            .controls-deck { gap: 10px; padding: 0 10px; }
            .btn-opt { width: 60px; height: 60px; font-size: 0.8rem; }
            .shutter-outer { width: 70px; height: 70px; }
            .shutter-inner { width: 60px; height: 60px; }
        }

    </style>
</head>
<body>

    <div id="monitor">
        <div class="scanlines"></div>
        <div class="screen-glow"></div>

        <div id="screen-boot" class="screen active">
            <div id="boot-log"></div>
            <span class="cursor-blink">_</span>
        </div>

        <div id="screen-attract" class="screen hidden">
            <div class="brand-box">
                <div class="title-main">SENA<br>PHOTOBOOTH</div>
                <div class="title-sub">SYSTEM OS v2.0</div>
            </div>
            
            <button class="coin-trigger" onclick="OS.insertCoin()">
                <div class="coin-text">INSERT COIN</div>
            </button>
            <div style="margin-top: 20px; font-family: var(--f-code); color: #666;">CREDIT 0/1</div>
        </div>

        <div id="screen-live" class="screen hidden">
            <div class="top-status">
                <div class="live-tag"><div class="live-dot"></div> REC</div>
                <div id="clock">00:00:00</div>
            </div>

            <div class="viewfinder">
                <video id="cam-feed" autoplay playsinline muted></video>
                <div class="grid-lines" id="grid-overlay"></div>
                <div id="count-display">3</div>
                
                <div class="grid-toggle" onclick="OS.toggleGrid()"># GRID</div>
            </div>

            <div class="controls-deck">
                <button class="btn-opt active" onclick="OS.setFilter('color', this)">
                    <span>CLR</span>
                </button>
                <button class="btn-opt" onclick="OS.setFilter('bw', this)">
                    <span>B&W</span>
                </button>
                <button class="btn-opt" onclick="OS.setFilter('film', this)">
                    <span>FILM</span>
                </button>

                <div class="shutter-outer" id="shutter-btn" onclick="OS.captureSequence()">
                    <div class="shutter-inner"></div>
                </div>
                
                <div style="width: 70px;"></div>
            </div>
        </div>

        <div id="screen-result" class="screen hidden">
            <div class="print-preview-box" id="print-box">
                <img id="final-strip" alt="Photo Strip">
            </div>
            
            <div class="action-row">
                <button class="btn-action" onclick="OS.download()">DOWNLOAD</button>
                <button class="btn-action secondary" onclick="location.reload()">RESTART</button>
            </div>
        </div>

    </div>

    <div id="flash-overlay"></div>
    <canvas id="processor" style="display:none;"></canvas>

    <script>
        /**
         * SENA OS CORE 2.0
         * "The System"
         */
        const OS = (function() {
            
            // --- CONFIGURATION ---
            const CONFIG = {
                width: 1280,
                height: 720,
                stripW: 600,
                shots: 3,
                countdown: 3,
                quotes: ["GOOD VIBES ONLY", "MEMORIES KEPT", "SENA PHOTOBOOTH", "TIMELESS", "FOREVER YOUNG", "JUST SMILE"]
            };

            // --- STATE ---
            let state = {
                filter: 'color', // color | bw | film
                stream: null,
                photos: [],
                grid: false,
                processing: false
            };

            // --- DOM CACHE ---
            const D = {
                screens: {
                    boot: document.getElementById('screen-boot'),
                    attract: document.getElementById('screen-attract'),
                    live: document.getElementById('screen-live'),
                    result: document.getElementById('screen-result')
                },
                video: document.getElementById('cam-feed'),
                canvas: document.getElementById('processor'),
                ctx: document.getElementById('processor').getContext('2d'),
                count: document.getElementById('count-display'),
                flash: document.getElementById('flash-overlay'),
                grid: document.getElementById('grid-overlay'),
                shutter: document.getElementById('shutter-btn'),
                finalImg: document.getElementById('final-strip'),
                printBox: document.getElementById('print-box'),
                clock: document.getElementById('clock'),
                bootLog: document.getElementById('boot-log')
            };

            // --- AUDIO SYSTEM (Synthesized) ---
            const AudioFX = {
                ctx: null,
                init: function() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
                beep: function(freq=800, dur=0.1, type='square') {
                    this.init();
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.type = type; o.frequency.value = freq;
                    o.connect(g); g.connect(this.ctx.destination);
                    g.gain.value = 0.05; o.start(); o.stop(this.ctx.currentTime + dur);
                },
                coin: function() {
                    this.init();
                    this.beep(1200, 0.1, 'sine');
                    setTimeout(() => this.beep(2000, 0.2, 'square'), 100);
                },
                shutter: function() {
                    this.init();
                    // Noise Burst
                    const bSize = this.ctx.sampleRate * 0.1;
                    const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                    const d = b.getChannelData(0);
                    for(let i=0; i<bSize; i++) d[i] = Math.random() * 2 - 1;
                    const src = this.ctx.createBufferSource();
                    const g = this.ctx.createGain();
                    src.buffer = b; src.connect(g); g.connect(this.ctx.destination);
                    g.gain.value = 0.3; src.start();
                }
            };

            // --- INIT SEQUENCE ---
            window.onload = function() {
                bootSequence();
            };

            async function bootSequence() {
                const logs = [
                    "BIOS DATE 01/01/98 14:22:51 VER 1.02",
                    "CPU: SENA-PROCESSOR @ 233MHZ",
                    "640K RAM SYSTEM OK",
                    "LOADING OS...",
                    "MOUNTING CAMERA... OK",
                    "INITIALIZING SOUND... OK",
                    "LOADING UI RESOURCES...",
                    "SYSTEM READY."
                ];

                for (let line of logs) {
                    D.bootLog.innerHTML += line + "<br>";
                    await delay(300); // Typing speed
                }
                await delay(800);
                
                D.screens.boot.classList.remove('active');
                setTimeout(() => D.screens.boot.style.display = 'none', 500);
                D.screens.attract.classList.remove('hidden');
                D.screens.attract.classList.add('active');
            }

            // --- CLOCK ---
            setInterval(() => {
                const now = new Date();
                D.clock.innerText = now.toLocaleTimeString('en-GB');
            }, 1000);


            // --- CORE FUNCTIONS ---

            async function insertCoin() {
                AudioFX.coin();
                try {
                    state.stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'user', width: CONFIG.width, height: CONFIG.height },
                        audio: false
                    });
                    D.video.srcObject = state.stream;
                    
                    switchScreen('live');
                } catch(e) {
                    alert("ERROR: Camera Access Denied");
                    console.error(e);
                }
            }

            function switchScreen(name) {
                // Hide all
                Object.values(D.screens).forEach(s => {
                    s.classList.remove('active');
                    s.classList.add('hidden');
                });
                // Show Target
                const target = D.screens[name];
                target.style.display = 'flex'; // Ensure flex
                // Reflow
                void target.offsetWidth;
                target.classList.remove('hidden');
                target.classList.add('active');
            }

            function toggleGrid() {
                state.grid = !state.grid;
                if(state.grid) D.grid.classList.add('visible');
                else D.grid.classList.remove('visible');
                AudioFX.beep(600, 0.05);
            }

            function setFilter(mode, btn) {
                state.filter = mode;
                // UI
                document.querySelectorAll('.btn-opt').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                // Preview CSS
                let css = 'none';
                if(mode === 'bw') css = 'grayscale(100%) contrast(1.2)';
                if(mode === 'film') css = 'sepia(0.3) contrast(1.1) saturate(0.8)';
                D.video.style.filter = css;
                
                AudioFX.beep(600, 0.05);
            }

            async function captureSequence() {
                if(state.processing) return;
                state.processing = true;
                state.photos = [];
                D.shutter.classList.add('locked');

                // 3 Shots
                for(let i=0; i<CONFIG.shots; i++) {
                    await runCountdown(CONFIG.countdown);
                    await takePhoto();
                    await delay(500); // Pause between shots
                }

                // Process
                D.shutter.classList.remove('locked');
                state.processing = false;
                renderStrip();
            }

            function runCountdown(sec) {
                return new Promise(resolve => {
                    let n = sec;
                    D.count.style.display = 'block';
                    D.count.innerText = n;
                    
                    const timer = setInterval(() => {
                        AudioFX.beep(800, 0.1);
                        n--;
                        if(n > 0) {
                            D.count.innerText = n;
                        } else {
                            clearInterval(timer);
                            D.count.style.display = 'none';
                            resolve();
                        }
                    }, 1000);
                    AudioFX.beep(800, 0.1); // First beep
                });
            }

            function takePhoto() {
                return new Promise(resolve => {
                    AudioFX.shutter();
                    // Flash
                    D.flash.classList.add('anim-flash');
                    setTimeout(() => D.flash.classList.remove('anim-flash'), 250);

                    // Capture to Canvas
                    const w = D.video.videoWidth;
                    const h = D.video.videoHeight;
                    const cvs = document.createElement('canvas');
                    cvs.width = w; cvs.height = h;
                    const ctx = cvs.getContext('2d');

                    // Mirror
                    ctx.translate(w, 0); ctx.scale(-1, 1);
                    ctx.drawImage(D.video, 0, 0);

                    // --- APPLY FILTERS (PIXEL LEVEL) ---
                    if(state.filter !== 'color') {
                        const imgData = ctx.getImageData(0,0,w,h);
                        const d = imgData.data;
                        
                        for(let i=0; i<d.length; i+=4) {
                            const r=d[i], g=d[i+1], b=d[i+2];
                            
                            if(state.filter === 'bw') {
                                // High Contrast BW
                                let gray = 0.299*r + 0.587*g + 0.114*b;
                                gray = gray > 127 ? gray + 10 : gray - 10; // Simple contrast
                                d[i] = d[i+1] = d[i+2] = gray;
                            } 
                            else if(state.filter === 'film') {
                                // Sepia + Warmth
                                d[i]   = (r * 0.393) + (g * 0.769) + (b * 0.189); // R
                                d[i+1] = (r * 0.349) + (g * 0.686) + (b * 0.168); // G
                                d[i+2] = (r * 0.272) + (g * 0.534) + (b * 0.131); // B
                                
                                // Add Noise (Grain)
                                const noise = (Math.random() - 0.5) * 30;
                                d[i]+=noise; d[i+1]+=noise; d[i+2]+=noise;
                            }
                        }
                        ctx.putImageData(imgData, 0, 0);
                    }
                    
                    // Add Vignette for FILM mode via Gradient
                    if(state.filter === 'film') {
                        ctx.globalCompositeOperation = 'multiply';
                        const grad = ctx.createRadialGradient(w/2, h/2, h/3, w/2, h/2, h);
                        grad.addColorStop(0, 'rgba(0,0,0,0)');
                        grad.addColorStop(1, 'rgba(0,0,0,0.4)');
                        ctx.fillStyle = grad;
                        ctx.setTransform(1,0,0,1,0,0); // Reset transform for overlay
                        ctx.fillRect(0,0,w,h);
                    }

                    state.photos.push(cvs);
                    setTimeout(resolve, 600);
                });
            }

            function renderStrip() {
                // Stop Camera
                if(state.stream) state.stream.getTracks().forEach(t=>t.stop());

                const stripW = CONFIG.stripW;
                const photoW = 520;
                const photoH = (photoW * 3) / 4;
                const gap = 25;
                const headH = 160;
                const footH = 120;
                const totalH = headH + (photoH * 3) + (gap * 2) + footH;

                D.canvas.width = stripW; D.canvas.height = totalH;
                const ctx = D.ctx;

                // 1. Paper Base
                ctx.fillStyle = '#fdfdfd';
                ctx.fillRect(0,0, stripW, totalH);

                // 2. Header
                ctx.fillStyle = '#111';
                ctx.textAlign = 'center';
                
                // Main Logo
                ctx.font = 'bold 50px "DM Sans"';
                ctx.letterSpacing = '-2px';
                ctx.fillText('SENA', stripW/2, 80);
                
                ctx.font = '700 32px "DM Sans"';
                ctx.letterSpacing = '0px';
                ctx.fillText('PHOTOBOOTH', stripW/2, 120);

                // 3. Draw Photos
                let y = headH;
                state.photos.forEach(p => {
                    // Crop Center Logic
                    const sRat = p.width / p.height;
                    const dRat = 4/3;
                    let sx, sy, sw, sh;
                    if(sRat > dRat) {
                        sh = p.height; sw = sh * dRat;
                        sx = (p.width - sw)/2; sy=0;
                    } else {
                        sw = p.width; sh = sw / dRat;
                        sx = 0; sy = (p.height - sh)/2;
                    }

                    ctx.drawImage(p, sx, sy, sw, sh, (stripW-photoW)/2, y, photoW, photoH);
                    y += photoH + gap;
                });

                // 4. Footer info
                // Date
                const date = new Date();
                const dateStr = date.toLocaleDateString('en-GB', { day:'2-digit', month:'2-digit', year:'2-digit' });
                const timeStr = date.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                
                ctx.fillStyle = '#666';
                ctx.font = '22px "VT323"'; // Retro font for data
                ctx.textAlign = 'left';
                ctx.fillText(`${dateStr} ${timeStr}`, 40, totalH - 45);

                // Random Quote
                const quote = CONFIG.quotes[Math.floor(Math.random() * CONFIG.quotes.length)];
                ctx.textAlign = 'right';
                ctx.font = 'bold 18px "DM Sans"';
                ctx.letterSpacing = '1px';
                ctx.fillStyle = '#000';
                ctx.fillText(quote, stripW - 40, totalH - 45);

                // Barcode Decoration
                ctx.fillStyle = '#000';
                ctx.fillRect(40, totalH - 30, stripW - 80, 4);

                // Show Result
                const dataURL = D.canvas.toDataURL('image/jpeg', 0.95);
                D.finalImg.src = dataURL;
                
                switchScreen('result');
                setTimeout(() => D.printBox.classList.add('show'), 100);
            }

            function download() {
                const link = document.createElement('a');
                link.download = `SENA_${Date.now()}.jpg`;
                link.href = D.canvas.toDataURL('image/jpeg', 1.0);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

            return {
                insertCoin, toggleGrid, setFilter, captureSequence, download
            };

        })();
    </script>
</body>
</html>
